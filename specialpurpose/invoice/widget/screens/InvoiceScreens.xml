<?xml version="1.0" encoding="UTF-8"?>
<screens xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://ofbiz.apache.org/Widget-Screen"
         xsi:schemaLocation="http://ofbiz.apache.org/Widget-Screen http://ofbiz.apache.org/dtds/widget-screen.xsd">

    <!-- ================= -->
    <!-- Pantalla principal -->
    <!-- ================= -->
    <screen name="main">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="FindInvoices"/>
            </actions>
            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>
                                <include-screen name="FindInvoicesBody"/>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <!-- =================== -->
    <!-- Cuerpo: buscar/lista -->
    <!-- =================== -->
    <screen name="FindInvoicesBody">
        <section>
            <widgets>

                <!-- Filtros -->
                <include-form name="FindInvoicesForm" location="component://invoice/widget/forms/InvoiceForms.xml"/>

                <!-- Sin filtros => lista completa -->
                <section>
                    <condition>
                        <and>
                            <if-empty field="parameters.invInvoiceNumber"/>
                            <if-empty field="parameters.invSupplierCode"/>
                            <if-empty field="parameters.invSupplierVatNumber"/>
                            <if-empty field="parameters.invInvoiceDateFrom"/>
                            <if-empty field="parameters.invInvoiceDateTo"/>
                            <if-empty field="parameters.invValueDateFrom"/>
                            <if-empty field="parameters.invValueDateTo"/>
                            <if-empty field="parameters.invPaymentDueDateFrom"/>
                            <if-empty field="parameters.invPaymentDueDateTo"/>
                            <if-empty field="parameters.invTaxType"/>
                            <if-empty field="parameters.invTaxRate"/>
                            <if-empty field="parameters.invCurrency"/>
                            <if-empty field="parameters.invPaymentMethod"/>
                            <if-empty field="parameters.invNetAmountFrom"/>
                            <if-empty field="parameters.invNetAmountTo"/>
                            <if-empty field="parameters.invConfirmed"/>
                            <if-empty field="parameters.invPaymentDone"/>
                        </and>
                    </condition>
                    <widgets>
                        <include-form name="ListInvoicesFormFull" location="component://invoice/widget/forms/InvoiceForms.xml"/>
                    </widgets>
                </section>

                <!-- Con filtros => lista filtrada (usa entityList que ya venga en contexto) -->
                <section>
                    <condition>
                        <not>
                            <and>
                                <if-empty field="parameters.invInvoiceNumber"/>
                                <if-empty field="parameters.invSupplierCode"/>
                                <if-empty field="parameters.invSupplierVatNumber"/>
                                <if-empty field="parameters.invInvoiceDateFrom"/>
                                <if-empty field="parameters.invInvoiceDateTo"/>
                                <if-empty field="parameters.invValueDateFrom"/>
                                <if-empty field="parameters.invValueDateTo"/>
                                <if-empty field="parameters.invPaymentDueDateFrom"/>
                                <if-empty field="parameters.invPaymentDueDateTo"/>
                                <if-empty field="parameters.invTaxType"/>
                                <if-empty field="parameters.invTaxRate"/>
                                <if-empty field="parameters.invCurrency"/>
                                <if-empty field="parameters.invPaymentMethod"/>
                                <if-empty field="parameters.invNetAmountFrom"/>
                                <if-empty field="parameters.invNetAmountTo"/>
                                <if-empty field="parameters.invConfirmed"/>
                                <if-empty field="parameters.invPaymentDone"/>
                            </and>
                        </not>
                    </condition>
                    <widgets>
                        <include-form name="ListInvoicesForm" location="component://invoice/widget/forms/InvoiceForms.xml"/>
                        <platform-specific><html><html-template location="component://invoice/webapp/invoice/includes/invoiceListDblClick.ftl"/></html></platform-specific>
                    </widgets>
                </section>

            </widgets>
        </section>
    </screen>

    <screen name="ViewInvoiceHeader">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="ViewInvoice"/>
                <entity-one entity-name="FinInvoice" value-field="invoice">
                    <field-map field-name="invoiceId" from-field="parameters.invoiceId"/>
                </entity-one>
            </actions>
            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <condition><if-empty field="invoice"/></condition>
                            <widgets>
                                <label style="required-field" text="Invoice not found"/>
                                <container>
                                    <link target="findInvoices" text="${uiLabelMap.CommonBack}" style="buttontext"/>
                                </container>
                            </widgets>
                        </section>
                        <section>
                            <condition><not><if-empty field="invoice"/></not></condition>
                            <widgets>
                                <container>
                                    <link text="${uiLabelMap.CommonPrint}" style="buttontext"
                                          target="javascript:window.print();" url-mode="plain"/>
                                </container>
                                <!-- Reutilizamos tu form de cabecera -->
                                <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                              name="ViewInvoiceForm"/>
                                <container>
                                    <link target="findInvoices" text="${uiLabelMap.CommonBack}" style="buttontext"/>
                                    <link target="viewInvoiceLines" text="Invoice Lines" style="buttontext">
                                        <parameter param-name="invoiceId" from-field="parameters.invoiceId"/>
                                    </link>
                                </container>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <!-- ===================== -->
    <!-- Pantalla: editar cab. -->
    <!-- ===================== -->
    <screen name="EditInvoice">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="EditInvoice"/>
            </actions>
            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>
                                <include-screen name="EditInvoiceBody"/>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <screen name="EditInvoiceBody">
        <section>
            <widgets>
                <label text="Edit Invoice Data"/>
                <include-form name="EditInvoiceForm" location="component://invoice/widget/forms/InvoiceForms.xml"/>
            </widgets>
        </section>
    </screen>

    <!-- ===================== -->
    <!-- Pantalla: ver cabecera -->
    <!-- ===================== -->
    <screen name="ViewInvoice">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="ViewInvoice"/>

                <!-- Cargar la cabecera y guardarla como 'invoice' -->
                <entity-one entity-name="FinInvoice" value-field="invoice">
                    <field-map field-name="invoiceId" from-field="parameters.invoiceId"/>
                </entity-one>
                <!-- Cargar líneas usando performFind -->
                <service service-name="performFind" result-map="findLines">
                    <field-map field-name="entityName" value="FinInvoiceLine"/>
                    <!-- Pasamos todos los parámetros (incluye invoiceId); el servicio filtrará por invoiceId -->
                    <field-map field-name="inputFields" from-field="parameters"/>
                    <field-map field-name="orderBy" value="invoiceLineSeqId"/>
                    <field-map field-name="noConditionFind" value="Y"/>
                    <field-map field-name="userLogin" from-field="userLogin"/>
                </service>

                <!-- Poner la lista en el contexto con el nombre que usa tu form -->
                <script location="component://invoice/scripts/computeInvoiceTotals.groovy"/>
            </actions>

            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">

                        <!-- Si NO existe la factura -->
                        <section>
                            <condition>
                                <if-empty field="invoice"/>
                            </condition>
                            <widgets>
                                <label style="required-field" text="Invoice not found"/>
                                <container>
                                    <link target="findInvoices" text="${uiLabelMap.CommonBack}" style="buttontext"/>
                                </container>
                            </widgets>
                        </section>

                        <!-- Si SÍ existe la factura -->
                        <section>
                            <condition>
                                <not><if-empty field="invoice"/></not>
                            </condition>
                            <widgets>
                                <container>
                                    <link text="${uiLabelMap.CommonPrint}" style="buttontext"
                                          target="javascript:window.print();" url-mode="plain"/>
                                </container>

                                <!-- Form de detalle: usa default-map-name="invoice" -->
                                <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                              name="ViewInvoiceForm"/>

                                <!-- Cuando tengas líneas, podrás incluir su lista aquí -->
                                <label text="Invoice Line Items" style="h3"/>
                                <include-form location="component://invoice/widget/forms/InvoiceForms.xml" name="ListInvoiceLines"/>

                                <!-- Fila de totales -->
                                <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                              name="InvoiceLinesTotals"/>

                                <container>
                                    <link target="findInvoices" text="${uiLabelMap.CommonBack}" style="buttontext"/>
                                </container>

                            </widgets>
                        </section>

                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <!-- ======================== -->
    <!-- Pantalla: editar la línea -->
    <!-- ======================== -->
    <screen name="EditInvoiceLine">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="EditInvoiceLine"/>
            </actions>
            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>
                                <include-screen name="EditInvoiceLineBody"/>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <screen name="EditInvoiceLineBody">
        <section>
            <widgets>
                <label text="Edit Invoice Line"/>
                <include-form name="EditInvoiceLineForm" location="component://invoice/widget/forms/InvoiceForms.xml"/>
            </widgets>
        </section>
    </screen>

</screens>
