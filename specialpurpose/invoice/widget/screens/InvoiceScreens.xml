<?xml version="1.0" encoding="UTF-8"?>
<screens xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://ofbiz.apache.org/Widget-Screen"
         xsi:schemaLocation="http://ofbiz.apache.org/Widget-Screen http://ofbiz.apache.org/dtds/widget-screen.xsd">

    <!-- ================= -->
    <!-- Pantalla principal -->
    <!-- ================= -->
    <screen name="main">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="FindInvoices"/>
            </actions>
            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>
                                <include-screen name="FindInvoicesBody"/>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <!-- =================== -->
    <!-- Cuerpo: buscar/lista -->
    <!-- =================== -->
    <screen name="FindInvoicesBody">
        <section>
            <widgets>

                <!-- Caja del buscador -->
                <container style="screenlet inv-search">
                    <container style="screenlet-title-bar">
                        <label text="Búscar Facturas" style="h3"/>
                    </container>
                    <container style="screenlet-body">
                        <include-form name="FindInvoicesForm"
                                      location="component://invoice/widget/forms/InvoiceForms.xml"/>
                    </container>
                </container>

                <!-- Sin filtros => lista completa -->
                <section>
                    <condition>
                        <and>
                            <if-empty field="parameters.invInvoiceNumber"/>
                            <if-empty field="parameters.invSupplierCode"/>
                            <if-empty field="parameters.invSupplierVatNumber"/>
                            <if-empty field="parameters.invInvoiceDateFrom"/>
                            <if-empty field="parameters.invInvoiceDateTo"/>
                            <if-empty field="parameters.invValueDateFrom"/>
                            <if-empty field="parameters.invValueDateTo"/>
                            <if-empty field="parameters.invPaymentDueDateFrom"/>
                            <if-empty field="parameters.invPaymentDueDateTo"/>
                            <if-empty field="parameters.invTaxType"/>
                            <if-empty field="parameters.invTaxRate"/>
                            <if-empty field="parameters.invCurrency"/>
                            <if-empty field="parameters.invPaymentMethod"/>
                            <if-empty field="parameters.invNetAmountFrom"/>
                            <if-empty field="parameters.invNetAmountTo"/>
                            <if-empty field="parameters.invConfirmed"/>
                            <if-empty field="parameters.invPaymentDone"/>
                        </and>
                    </condition>
                    <actions>
                        <!-- Paginación en el CONTEXTO RAÍZ -->
                        <set field="viewIndex" from-field="parameters.viewIndex" default-value="0"/>
                        <set field="viewSize"  from-field="parameters.viewSize"  default-value="10"/>
                        <!-- Para que el combo del buscador muestre el valor actual -->
                        <set field="parameters.viewSize" from-field="parameters.viewSize" default-value="10"/>
                    </actions>
                    <widgets>
                        <include-form name="ListInvoicesFormFull" location="component://invoice/widget/forms/InvoiceForms.xml"/>
                    </widgets>
                </section>

                <!-- Con filtros => lista filtrada (usa entityList que ya venga en contexto) -->
                <section>
                    <condition>
                        <not>
                            <and>
                                <if-empty field="parameters.invInvoiceNumber"/>
                                <if-empty field="parameters.invSupplierCode"/>
                                <if-empty field="parameters.invSupplierVatNumber"/>
                                <if-empty field="parameters.invInvoiceDateFrom"/>
                                <if-empty field="parameters.invInvoiceDateTo"/>
                                <if-empty field="parameters.invValueDateFrom"/>
                                <if-empty field="parameters.invValueDateTo"/>
                                <if-empty field="parameters.invPaymentDueDateFrom"/>
                                <if-empty field="parameters.invPaymentDueDateTo"/>
                                <if-empty field="parameters.invTaxType"/>
                                <if-empty field="parameters.invTaxRate"/>
                                <if-empty field="parameters.invCurrency"/>
                                <if-empty field="parameters.invPaymentMethod"/>
                                <if-empty field="parameters.invNetAmountFrom"/>
                                <if-empty field="parameters.invNetAmountTo"/>
                                <if-empty field="parameters.invConfirmed"/>
                                <if-empty field="parameters.invPaymentDone"/>
                            </and>
                        </not>
                    </condition>
                    <actions>
                        <!-- Paginación en el CONTEXTO RAÍZ -->
                        <set field="viewIndex" from-field="parameters.viewIndex" default-value="0"/>
                        <set field="viewSize"  from-field="parameters.viewSize"  default-value="10"/>
                        <!-- Para que el combo del buscador muestre el valor actual -->
                        <set field="parameters.viewSize" from-field="parameters.viewSize" default-value="10"/>
                    </actions>
                    <widgets>
                        <include-form name="ListInvoicesForm" location="component://invoice/widget/forms/InvoiceForms.xml"/>
                    </widgets>
                </section>

            </widgets>
        </section>
    </screen>

    <!-- ===================== -->
    <!-- Pantalla: editar cab. -->
    <!-- ===================== -->
    <screen name="EditInvoice">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="EditInvoice"/>
            </actions>
            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>
                                <include-screen name="EditInvoiceBody"/>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <screen name="EditInvoiceBody">
        <section>
            <widgets>
                <label text="Edit Invoice Data"/>
                <include-form name="EditInvoiceForm" location="component://invoice/widget/forms/InvoiceForms.xml"/>
            </widgets>
        </section>
    </screen>

    <!-- ===================== -->
    <!-- View: solo cabecera   -->
    <!-- ===================== -->
    <screen name="ViewInvoiceHeader">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="ViewInvoice"/>

                <!-- Cargar solo la cabecera -->
                <entity-one entity-name="FinInvoice" value-field="invoice">
                    <field-map field-name="invoiceId" from-field="parameters.invoiceId"/>
                </entity-one>
            </actions>

            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">

                        <!-- Si NO existe la factura -->
                        <section>
                            <condition><if-empty field="invoice"/></condition>
                            <widgets>
                                <label style="required-field" text="Invoice not found"/>
                                <container>
                                    <link target="findInvoices" text="${uiLabelMap.CommonBack}" style="buttontext"/>
                                </container>
                            </widgets>
                        </section>

                        <!-- Si SÍ existe la factura: mostrar cabecera -->
                        <section>
                            <condition><not><if-empty field="invoice"/></not></condition>
                            <widgets>
                                <container>
                                    <link text="${uiLabelMap.CommonPrint}" style="buttontext"
                                          target="javascript:window.print();" url-mode="plain"/>
                                </container>

                                <!-- Form de detalle: usa default-map-name="invoice" -->
                                <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                              name="ViewInvoiceForm"/>

                                <container style="buttons">
                                    <link target="findInvoices" text="${uiLabelMap.CommonBack}" style="buttontext"/>
                                </container>
                            </widgets>
                        </section>

                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <!-- ===================== -->
    <!-- Pantalla: ver cabecera -->
    <!-- ===================== -->
    <screen name="ViewInvoice">
        <section>
            <actions>
                <!-- Etiquetas comunes y del módulo -->
                <property-map resource="CommonUiLabels"  map-name="uiLabelMap" global="true"/>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>

                <!-- Cabecera -->
                <entity-one entity-name="FinInvoice" value-field="invoice">
                    <field-map field-name="invoiceId" from-field="parameters.invoiceId"/>
                </entity-one>

                <!-- Líneas -->
                <service service-name="performFind" result-map="findLines">
                    <field-map field-name="entityName" value="FinInvoiceLine"/>
                    <field-map field-name="inputFields" from-field="parameters"/>
                    <field-map field-name="orderBy" value="invoiceLineSeqId"/>
                    <field-map field-name="noConditionFind" value="Y"/>
                    <field-map field-name="userLogin" from-field="userLogin"/>
                </service>

                <!-- (Opcional) deja la lista explícita por si tu script la usa -->
                <set field="invoiceLines" from-field="findLines.listIt"/>

                <!-- Totales y/o otros cálculos -->
                <script location="component://invoice/scripts/computeInvoiceTotals.groovy"/>
            </actions>

            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>
                                <container>
                                    <link text="${uiLabelMap.CommonPrint}" style="buttontext"
                                          target="javascript:window.print();" url-mode="plain"/>
                                </container>

                                <!-- Detalle factura -->
                                <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                              name="ViewInvoiceForm"/>

                                <!-- Líneas -->
                                <label text="Invoice Line Items" style="h3"/>
                                <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                              name="ListInvoiceLines"/>

                                <container style="buttons">
                                    <link target="findInvoices" text="${uiLabelMap.CommonBack}" style="buttontext"/>
                                </container>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <!-- ======================== -->
    <!-- Pantalla: editar la línea -->
    <!-- ======================== -->
    <screen name="EditInvoiceLine">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="EditInvoiceLine"/>
            </actions>
            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>
                                <include-screen name="EditInvoiceLineBody"/>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <screen name="EditInvoiceLineBody">
        <section>
            <widgets>
                <label text="Edit Invoice Line"/>
                <include-form name="EditInvoiceLineForm" location="component://invoice/widget/forms/InvoiceForms.xml"/>
            </widgets>
        </section>
    </screen>

</screens>
