<?xml version="1.0" encoding="UTF-8"?>
<screens xmlns="http://ofbiz.apache.org/Widget-Screen"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://ofbiz.apache.org/Widget-Screen http://ofbiz.apache.org/dtds/widget-screen.xsd">

    <!-- ================= -->
    <!-- Pantalla principal -->
    <!-- ================= -->
    <screen name="main">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="FindInvoices"/>
            </actions>
            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>
                                <include-screen name="FindInvoicesBody"/>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <!-- =================== -->
    <!-- Cuerpo: buscar/lista -->
    <!-- =================== -->
    <screen name="FindInvoicesBody">
        <section>
            <widgets>

                <!-- Caja del buscador -->
                <container style="screenlet inv-section inv-search">
                    <container style="screenlet-title-bar"><label text="Buscar Facturas"/></container>
                    <container style="screenlet-body">
                        <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                      name="FindInvoicesForm"/>
                    </container>
                </container>

                <!-- Sin filtros => lista completa -->
                <section>
                    <condition>
                        <and>
                            <if-empty field="parameters.invInvoiceNumber"/>
                            <if-empty field="parameters.invSupplierCode"/>
                            <if-empty field="parameters.invSupplierVatNumber"/>
                            <if-empty field="parameters.invInvoiceDateFrom"/>
                            <if-empty field="parameters.invInvoiceDateTo"/>
                            <if-empty field="parameters.invValueDateFrom"/>
                            <if-empty field="parameters.invValueDateTo"/>
                            <if-empty field="parameters.invPaymentDueDateFrom"/>
                            <if-empty field="parameters.invPaymentDueDateTo"/>
                            <if-empty field="parameters.invTaxType"/>
                            <if-empty field="parameters.invTaxRate"/>
                            <if-empty field="parameters.invCurrency"/>
                            <if-empty field="parameters.invPaymentMethod"/>
                            <if-empty field="parameters.invNetAmountFrom"/>
                            <if-empty field="parameters.invNetAmountTo"/>
                            <if-empty field="parameters.invConfirmed"/>
                            <if-empty field="parameters.invPaymentDone"/>
                        </and>
                    </condition>
                    <actions>
                        <!-- Paginación en el CONTEXTO RAÍZ -->
                        <set field="viewIndex" from-field="parameters.viewIndex" default-value="0"/>
                        <set field="viewSize" from-field="parameters.viewSize" default-value="10"/>
                        <!-- Para que el combo del buscador muestre el valor actual -->
                        <set field="parameters.viewSize" from-field="parameters.viewSize" default-value="10"/>
                    </actions>
                    <widgets>
                        <include-form name="ListInvoicesFormFull"
                                      location="component://invoice/widget/forms/InvoiceForms.xml"/>
                    </widgets>
                </section>

                <!-- Con filtros => lista filtrada (usa entityList que ya venga en contexto) -->
                <section>
                    <condition>
                        <not>
                            <and>
                                <if-empty field="parameters.invInvoiceNumber"/>
                                <if-empty field="parameters.invSupplierCode"/>
                                <if-empty field="parameters.invSupplierVatNumber"/>
                                <if-empty field="parameters.invInvoiceDateFrom"/>
                                <if-empty field="parameters.invInvoiceDateTo"/>
                                <if-empty field="parameters.invValueDateFrom"/>
                                <if-empty field="parameters.invValueDateTo"/>
                                <if-empty field="parameters.invPaymentDueDateFrom"/>
                                <if-empty field="parameters.invPaymentDueDateTo"/>
                                <if-empty field="parameters.invTaxType"/>
                                <if-empty field="parameters.invTaxRate"/>
                                <if-empty field="parameters.invCurrency"/>
                                <if-empty field="parameters.invPaymentMethod"/>
                                <if-empty field="parameters.invNetAmountFrom"/>
                                <if-empty field="parameters.invNetAmountTo"/>
                                <if-empty field="parameters.invConfirmed"/>
                                <if-empty field="parameters.invPaymentDone"/>
                            </and>
                        </not>
                    </condition>
                    <actions>
                        <!-- Paginación en el CONTEXTO RAÍZ -->
                        <set field="viewIndex" from-field="parameters.viewIndex" default-value="0"/>
                        <set field="viewSize" from-field="parameters.viewSize" default-value="10"/>
                        <!-- Para que el combo del buscador muestre el valor actual -->
                        <set field="parameters.viewSize" from-field="parameters.viewSize" default-value="10"/>
                    </actions>
                    <widgets>
                        <include-form name="ListInvoicesForm"
                                      location="component://invoice/widget/forms/InvoiceForms.xml"/>
                    </widgets>
                </section>

            </widgets>
        </section>
    </screen>

    <!-- ===================== -->
    <!-- Pantalla: editar cab. -->
    <!-- ===================== -->
    <screen name="EditInvoice">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="EditInvoice"/>
            </actions>
            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>
                                <include-screen name="EditInvoiceBody"/>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <screen name="EditInvoiceBody">
        <section>
            <widgets>
                <label text="Edit Invoice Data"/>
                <include-form name="EditInvoiceForm" location="component://invoice/widget/forms/InvoiceForms.xml"/>
            </widgets>
        </section>
    </screen>

    <!-- ===================== -->
    <!-- View: solo cabecera   -->
    <!-- ===================== -->
    <screen name="ViewInvoiceHeader">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="ViewInvoice"/>

                <!-- Cargar solo la cabecera -->
                <entity-one entity-name="FinInvoice" value-field="invoice">
                    <field-map field-name="invoiceId" from-field="parameters.invoiceId"/>
                </entity-one>
            </actions>

            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">

                        <!-- Si NO existe la factura -->
                        <section>
                            <condition>
                                <if-empty field="invoice"/>
                            </condition>
                            <widgets>
                                <label style="required-field" text="Invoice not found"/>
                                <container>
                                    <link target="findInvoices" text="${uiLabelMap.CommonBack}" style="buttontext"/>
                                </container>
                            </widgets>
                        </section>

                        <!-- Si SÍ existe la factura: mostrar cabecera -->
                        <section>
                            <condition>
                                <not>
                                    <if-empty field="invoice"/>
                                </not>
                            </condition>
                            <widgets>

                                <!-- ========== General ========== -->
                                <container style="screenlet inv-section">
                                    <container style="screenlet-title-bar">
                                        <label text="General Invoice Information"/>
                                    </container>
                                    <container style="screenlet-body">
                                        <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                                      name="ViewInv_General"/>
                                    </container>
                                </container>

                                <!-- ========== Supplier ========== -->
                                <container style="screenlet inv-section">
                                    <container style="screenlet-title-bar">
                                        <label text="Supplier Information"/>
                                    </container>
                                    <container style="screenlet-body">
                                        <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                                      name="ViewInv_Supplier"/>
                                    </container>
                                </container>

                                <!-- ========== Monetary ========== -->
                                <container style="screenlet inv-section">
                                    <container style="screenlet-title-bar">
                                        <label text="Monetary Details"/>
                                    </container>
                                    <container style="screenlet-body">
                                        <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                                      name="ViewInv_Monetary"/>
                                    </container>
                                </container>

                                <!-- ========== Tax & Payment ========== -->
                                <container style="screenlet inv-section">
                                    <container style="screenlet-title-bar">
                                        <label text="Tax and Payment Information"/>
                                    </container>
                                    <container style="screenlet-body">
                                        <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                                      name="ViewInv_TaxPayment"/>
                                    </container>
                                </container>

                                <!-- ========== Audit ========== -->
                                <container style="screenlet inv-section">
                                    <container style="screenlet-title-bar">
                                        <label text="Audit Information"/>
                                    </container>
                                    <container style="screenlet-body">
                                        <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                                      name="ViewInv_Audit"/>
                                    </container>
                                </container>

                                <!-- botones abajo -->
                                <container style="buttons">
                                    <link text="Generar PDF" style="buttontext" target="javascript:window.print();"
                                          url-mode="plain"/>
                                    <link target="findInvoices" text="${uiLabelMap.CommonBack}" style="buttontext"/>
                                </container>

                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <!-- ===================== -->
    <!-- Pantalla: ver cabecera -->
    <!-- ===================== -->
    <screen name="ViewInvoice">
        <section>
            <actions>
                <!-- Etiquetas -->
                <property-map resource="CommonUiLabels"  map-name="uiLabelMap" global="true"/>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>

                <!-- Cabecera -->
                <entity-one entity-name="FinInvoice" value-field="invoice">
                    <field-map field-name="invoiceId" from-field="parameters.invoiceId"/>
                </entity-one>

                <!-- Líneas -->
                <service service-name="performFind" result-map="findLines">
                    <field-map field-name="entityName" value="FinInvoiceLine"/>
                    <field-map field-name="inputFields" from-field="parameters"/>
                    <field-map field-name="orderBy" value="invoiceLineSeqId"/>
                    <field-map field-name="noConditionFind" value="Y"/>
                    <field-map field-name="userLogin" from-field="userLogin"/>
                </service>

                <!-- Pásalo explícito para el script -->
                <set field="invoiceLines" from-field="findLines.listIt"/>

                <!-- Totales -->
                <script location="component://invoice/scripts/computeInvoiceTotals.groovy"/>
            </actions>

            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>

                                <!-- ====== Resumen compacto (mock) ====== -->
                                <container style="screenlet inv-section inv-summary-card">
                                    <container style="screenlet-title-bar">
                                        <label text="Invoice Details"/>
                                    </container>
                                    <container style="screenlet-body">
                                        <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                                      name="InvoiceSummary"/>
                                    </container>
                                </container>

                                <!-- ====== Invoice Lines (lista + totales) ====== -->
                                <container style="screenlet inv-section">
                                    <container style="screenlet-title-bar">
                                        <label text="Invoice Line Items"/>
                                    </container>
                                    <container style="screenlet-body">

                                        <!-- Si no hay líneas -->
                                        <section>
                                            <condition><if-empty field="invoiceLines"/></condition>
                                            <widgets>
                                                <label style="required-field" text="No line items found for this invoice."/>
                                            </widgets>
                                        </section>

                                        <!-- Lista -->
                                        <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                                      name="ListInvoiceLines"/>

                                        <!-- Totales -->
                                        <section>
                                            <condition><not><if-empty field="totalsList"/></not></condition>
                                            <widgets>
                                                <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                                                              name="InvoiceLinesTotals"/>
                                            </widgets>
                                        </section>

                                    </container>
                                </container>

                                <!-- Botones -->
                                <container style="buttons">
                                    <link text="Generar PDF" style="buttontext" target="javascript:window.print();" url-mode="plain"/>
                                    <link target="findInvoices" text="${uiLabelMap.CommonBack}" style="buttontext"/>
                                </container>

                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <!-- ============================== -->
    <!-- Pantalla: edición rápida línea -->
    <!-- ============================== -->
    <screen name="EditInvoiceLineQuick">
        <section>
            <actions>
                <property-map resource="CommonUiLabels"  map-name="uiLabelMap" global="true"/>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <entity-one entity-name="FinInvoiceLine" value-field="line">
                    <field-map field-name="invoiceId"        from-field="parameters.invoiceId"/>
                    <field-map field-name="invoiceLineSeqId" from-field="parameters.invoiceLineSeqId"/>
                </entity-one>
                <!-- Refijar PKs por si acaso -->
                <set field="parameters.invoiceId"        from-field="line.invoiceId"/>
                <set field="parameters.invoiceLineSeqId" from-field="line.invoiceLineSeqId"/>
            </actions>
            <widgets>
                <include-form location="component://invoice/widget/forms/InvoiceForms.xml"
                              name="EditInvoiceLineQuick"/>
            </widgets>
        </section>
    </screen>

    <!-- ======================== -->
    <!-- Pantalla: editar la línea -->
    <!-- ======================== -->
    <screen name="EditInvoiceLine">
        <section>
            <actions>
                <property-map resource="InvoiceUiLabels" map-name="uiLabelMap" global="true"/>
                <set field="titleProperty" value="EditInvoiceLine"/>
            </actions>
            <widgets>
                <decorator-screen name="InvoiceCommonDecorator" location="component://invoice/widget/CommonScreens.xml">
                    <decorator-section name="body">
                        <section>
                            <widgets>
                                <include-screen name="EditInvoiceLineBody"/>
                            </widgets>
                        </section>
                    </decorator-section>
                </decorator-screen>
            </widgets>
        </section>
    </screen>

    <screen name="EditInvoiceLineBody">
        <section>
            <widgets>
                <label text="Edit Invoice Line"/>
                <include-form name="EditInvoiceLineQuick"
                              location="component://invoice/widget/forms/InvoiceForms.xml"/>
            </widgets>
        </section>
    </screen>

</screens>
