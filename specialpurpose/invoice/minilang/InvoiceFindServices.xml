<?xml version="1.0" encoding="UTF-8"?>
<simple-methods
        xmlns="http://ofbiz.apache.org/Simple-Method"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://ofbiz.apache.org/Simple-Method http://ofbiz.apache.org/dtds/simple-methods.xsd">

    <!-- =============================== -->
    <!-- findFinInvoicesDb               -->
    <!-- =============================== -->
    <simple-method method-name="findFinInvoicesDb" short-description="Find FinInvoice from DB">
        <!-- por defecto devolvemos iterador -->
        <if-empty field="listIt">
            <set field="listIt" value="true"/>
        </if-empty>

        <if-compare field="listIt" operator="equals" value="true">
            <entity-condition entity-name="FinInvoice" list="entityListIterator" distinct="false">
                <condition-list combine="and">

                    <!-- Texto: like/ignore-case -->
                    <condition-expr field-name="invSupplierVatNumber" operator="like" ignore-case="true" value="%${invSupplierVatNumber}%"/>
                    <condition-expr field-name="invSupplierName"     operator="like" ignore-case="true" value="%${invSupplierName}%"/>
                    <condition-expr field-name="invSupplierCode"     operator="like" ignore-case="true" value="%${invSupplierCode}%"/>
                    <condition-expr field-name="invInvoiceNumber"    operator="like" ignore-case="true" value="%${invInvoiceNumber}%"/>
                    <condition-expr field-name="invTaxType"          operator="like" ignore-case="true" value="%${invTaxType}%"/>
                    <condition-expr field-name="invCurrency"         operator="like" ignore-case="true" value="%${invCurrency}%"/>
                    <condition-expr field-name="invPaymentMethod"    operator="like" ignore-case="true" value="%${invPaymentMethod}%"/>

                    <!-- Fechas -->
                    <condition-list combine="and">
                        <condition-expr field-name="invInvoiceDate" operator="greater-equals" from-field="invInvoiceDateFrom"/>
                        <condition-expr field-name="invInvoiceDate" operator="less-equals"    from-field="invInvoiceDateTo"/>
                    </condition-list>

                    <condition-list combine="and">
                        <condition-expr field-name="invValueDate" operator="greater-equals" from-field="invValueDateFrom"/>
                        <condition-expr field-name="invValueDate" operator="less-equals"    from-field="invValueDateTo"/>
                    </condition-list>

                    <condition-list combine="and">
                        <condition-expr field-name="invPaymentDueDate" operator="greater-equals" from-field="invPaymentDueDateFrom"/>
                        <condition-expr field-name="invPaymentDueDate" operator="less-equals"    from-field="invPaymentDueDateTo"/>
                    </condition-list>

                    <!-- NumÃ©ricos -->
                    <condition-expr field-name="invIva"       operator="equals"         value="${invTaxRate}"/>
                    <condition-expr field-name="invNetAmount" operator="greater-equals" value="${invNetAmountFrom}"/>
                    <condition-expr field-name="invNetAmount" operator="less-equals"    value="${invNetAmountTo}"/>

                    <!-- Y/N -->
                    <condition-expr field-name="invConfirmed"   operator="equals" from-field="invConfirmed"/>
                    <condition-expr field-name="invPaymentDone" operator="equals" from-field="invPaymentDone"/>
                </condition-list>

                <order-by field-name="-invInvoiceDate"/>
                <order-by field-name="invInvoiceNumber"/>
                <use-iterator/>
            </entity-condition>
            <else>
                <entity-condition entity-name="FinInvoice" list="entityList" distinct="false">
                    <condition-list combine="and">
                        <condition-expr field-name="invSupplierVatNumber" operator="like" ignore-case="true" value="%${invSupplierVatNumber}%"/>
                        <condition-expr field-name="invSupplierName"     operator="like" ignore-case="true" value="%${invSupplierName}%"/>
                        <condition-expr field-name="invSupplierCode"     operator="like" ignore-case="true" value="%${invSupplierCode}%"/>
                        <condition-expr field-name="invInvoiceNumber"    operator="like" ignore-case="true" value="%${invInvoiceNumber}%"/>
                        <condition-expr field-name="invTaxType"          operator="like" ignore-case="true" value="%${invTaxType}%"/>
                        <condition-expr field-name="invCurrency"         operator="like" ignore-case="true" value="%${invCurrency}%"/>
                        <condition-expr field-name="invPaymentMethod"    operator="like" ignore-case="true" value="%${invPaymentMethod}%"/>

                        <condition-list combine="and">
                            <condition-expr field-name="invInvoiceDate" operator="greater-equals" from-field="invInvoiceDateFrom"/>
                            <condition-expr field-name="invInvoiceDate" operator="less-equals"    from-field="invInvoiceDateTo"/>
                        </condition-list>

                        <condition-list combine="and">
                            <condition-expr field-name="invValueDate" operator="greater-equals" from-field="invValueDateFrom"/>
                            <condition-expr field-name="invValueDate" operator="less-equals"    from-field="invValueDateTo"/>
                        </condition-list>

                        <condition-list combine="and">
                            <condition-expr field-name="invPaymentDueDate" operator="greater-equals" from-field="invPaymentDueDateFrom"/>
                            <condition-expr field-name="invPaymentDueDate" operator="less-equals"    from-field="invPaymentDueDateTo"/>
                        </condition-list>

                        <condition-expr field-name="invIva"       operator="equals"         value="${invTaxRate}"/>
                        <condition-expr field-name="invNetAmount" operator="greater-equals" value="${invNetAmountFrom}"/>
                        <condition-expr field-name="invNetAmount" operator="less-equals"    value="${invNetAmountTo}"/>

                        <condition-expr field-name="invConfirmed"   operator="equals" from-field="invConfirmed"/>
                        <condition-expr field-name="invPaymentDone" operator="equals" from-field="invPaymentDone"/>
                    </condition-list>

                    <order-by field-name="-invInvoiceDate"/>
                    <order-by field-name="invInvoiceNumber"/>
                </entity-condition>
            </else>
        </if-compare>

        <return/>
    </simple-method>

    <!-- =============================== -->
    <!-- getInvoiceDetailDataDb          -->
    <!-- =============================== -->
    <simple-method method-name="getInvoiceDetailDataDb" short-description="Invoice detail by invoiceId (or invInvoiceNumber fallback)">
        <!-- 1) Try by invoiceId -->
        <entity-one entity-name="FinInvoice" value-field="inv" auto-field-map="false">
            <field-map field-name="invoiceId" from-field="invoiceId"/>
        </entity-one>

        <!-- 2) Fallback invInvoiceNumber == invoiceId -->
        <if-empty field="inv">
            <entity-condition entity-name="FinInvoice" list="tmpList">
                <condition-expr field-name="invInvoiceNumber" operator="equals" from-field="invoiceId"/>
            </entity-condition>
            <if-not-empty field="tmpList">
                <first-from-list list="tmpList" entry="inv"/>
            </if-not-empty>
        </if-empty>

        <if-empty field="inv">
            <add-error><fail-message message="Invoice not found"/></add-error>
            <check-errors/>
            <return response-code="error"/>
        </if-empty>

        <!-- OUTs -->
        <set field="invAccountingCurrency" from-field="inv.invAccountingCurrency"/>
        <set field="invAmountWithoutVat"   from-field="inv.invAmountWithoutVat"/>
        <set field="invCompany"            from-field="inv.invCompany"/>
        <set field="invConfirmed"          from-field="inv.invConfirmed"/>
        <set field="invCountry"            from-field="inv.invCountry"/>
        <set field="invCurrency"           from-field="inv.invCurrency"/>
        <set field="invDocumentTypeCode"   from-field="inv.invDocumentTypeCode"/>
        <set field="invExchangeRate"       from-field="inv.invExchangeRate"/>
        <set field="invInvoiceDate"        from-field="inv.invInvoiceDate"/>
        <set field="invInvoiceNumber"      from-field="inv.invInvoiceNumber"/>
        <set field="invIrpf"               from-field="inv.invIrpf"/>
        <set field="invIva"                from-field="inv.invIva"/>
        <set field="invNetAmount"          from-field="inv.invNetAmount"/>
        <set field="invPaymentDone"        from-field="inv.invPaymentDone"/>
        <set field="invPaymentDueDate"     from-field="inv.invPaymentDueDate"/>
        <set field="invPaymentMethod"      from-field="inv.invPaymentMethod"/>
        <set field="invProof"              from-field="inv.invProof"/>
        <set field="invSupplierCode"       from-field="inv.invSupplierCode"/>
        <set field="invSupplierName"       from-field="inv.invSupplierName"/>
        <set field="invSupplierVatNumber"  from-field="inv.invSupplierVatNumber"/>
        <set field="invTaxType"            from-field="inv.invTaxType"/>
        <set field="invTotalAmountWithVat" from-field="inv.invTotalAmountWithVat"/>
        <set field="invTotalCharges"       from-field="inv.invTotalCharges"/>
        <set field="invTotalDiscounts"     from-field="inv.invTotalDiscounts"/>
        <set field="invTotalVatAmount"     from-field="inv.invTotalVatAmount"/>
        <set field="invUuid"               from-field="inv.invUuid"/>
        <set field="invValueDate"          from-field="inv.invValueDate"/>
        <set field="invTotalVatAmountInAccountingCurrency" from-field="inv.invTotalVatAmountInAccountingCurrency"/>
        <set field="invoiceId"             from-field="inv.invoiceId"/>

        <return/>
    </simple-method>

    <!-- =============================== -->
    <!-- findFinInvoiceLinesDb           -->
    <!-- =============================== -->
    <simple-method method-name="findFinInvoiceLinesDb" short-description="Find lines by invoiceId">
        <if-empty field="invoiceId">
            <add-error><fail-message message="Missing invoiceId"/></add-error>
            <check-errors/>
            <return response-code="error"/>
        </if-empty>

        <entity-condition entity-name="FinInvoiceLine" list="entityList">
            <condition-expr field-name="invoiceId" operator="equals" from-field="invoiceId"/>
            <order-by field-name="invoiceLineSeqId"/>
        </entity-condition>

        <return/>
    </simple-method>

</simple-methods>
