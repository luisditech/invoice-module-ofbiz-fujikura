<?xml version="1.0" encoding="UTF-8"?>
<simple-methods
        xmlns="http://ofbiz.apache.org/Simple-Method"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://ofbiz.apache.org/Simple-Method http://ofbiz.apache.org/dtds/simple-methods.xsd">

    <!-- ========================= -->
    <!-- FinInvoice - CREATE       -->
    <!-- ========================= -->
    <simple-method method-name="createFinInvoice" short-description="Create FinInvoice">
        <!--<check-permission permission="INVOICE" action="_CREATE">
            <fail-property resource="CommonUiLabels" property="CommonGenericPermissionError"/>
        </check-permission>-->
        <check-errors/>

        <make-value entity-name="FinInvoice" value-field="newFinInvoice"/>
        <set-nonpk-fields map="parameters" value-field="newFinInvoice"/>

        <!-- Si no viene invoiceId, lo generamos -->
        <if-empty field="newFinInvoice.invoiceId">
            <sequenced-id sequence-name="FinInvoice" field="newFinInvoice.invoiceId"/>
        </if-empty>

        <!-- Normaliza flags Y/N -->
        <if-empty field="newFinInvoice.invConfirmed">
            <set field="newFinInvoice.invConfirmed" value="N"/>
        </if-empty>
        <if-empty field="newFinInvoice.invPaymentDone">
            <set field="newFinInvoice.invPaymentDone" value="N"/>
        </if-empty>

        <create-value value-field="newFinInvoice"/>
        <field-to-result field="newFinInvoice.invoiceId" result-name="invoiceId"/>
        <log level="info" message="FinInvoice created with ID: ${invoiceId}"/>
        <return response-code="success"/>
    </simple-method>

    <!-- ========================= -->
    <!-- FinInvoice - UPDATE       -->
    <!-- ========================= -->
    <simple-method method-name="updateFinInvoice" short-description="Update FinInvoice">
        <!--<check-permission permission="INVOICE" action="_UPDATE">
            <fail-property resource="CommonUiLabels" property="CommonGenericPermissionError"/>
        </check-permission>-->
        <check-errors/>

        <entity-and entity-name="FinInvoice" list="finInvoices">
            <field-map field-name="invoiceId" from-field="parameters.invoiceId"/>
        </entity-and>
        <if-empty field="finInvoices">
            <add-error><fail-message message="FinInvoice with ID ${parameters.invoiceId} not found."/></add-error>
            <check-errors/>
            <return response-code="error"/>
        </if-empty>

        <first-from-list list="finInvoices" entry="finInvoiceToUpdate"/>
        <set-nonpk-fields map="parameters" value-field="finInvoiceToUpdate"/>
        <store-value value-field="finInvoiceToUpdate"/>

        <log level="info" message="FinInvoice with ID: ${parameters.invoiceId} updated."/>
        <return response-code="success"/>
    </simple-method>

    <!-- ========================= -->
    <!-- FinInvoice - DELETE (cascade lines) -->
    <!-- ========================= -->
    <simple-method method-name="deleteFinInvoice" short-description="Delete FinInvoice">
        <!--<check-permission permission="INVOICE" action="_DELETE">
            <fail-property resource="CommonUiLabels" property="CommonGenericPermissionError"/>
        </check-permission>-->
        <check-errors/>

        <!-- Busca cabecera -->
        <entity-and entity-name="FinInvoice" list="finInvoices">
            <field-map field-name="invoiceId" from-field="parameters.invoiceId"/>
        </entity-and>
        <if-empty field="finInvoices">
            <add-error><fail-message message="FinInvoice with ID ${parameters.invoiceId} not found for deletion."/></add-error>
            <check-errors/>
            <return response-code="error"/>
        </if-empty>
        <first-from-list list="finInvoices" entry="finInvoiceToDelete"/>

        <!-- Borrado en cascada: elimina lÃ­neas primero -->
        <make-value value-field="delMap" entity-name="FinInvoiceLine"/>
        <set-pk-fields map="parameters" value-field="delMap"/>
        <remove-by-and entity-name="FinInvoiceLine" map="delMap"/>

        <!-- Elimina cabecera -->
        <remove-value value-field="finInvoiceToDelete"/>

        <log level="info" message="FinInvoice with ID: ${parameters.invoiceId} and its lines deleted."/>
        <return response-code="success"/>
    </simple-method>

    <!-- ========================= -->
    <!-- FinInvoiceLine - CREATE   -->
    <!-- ========================= -->
    <simple-method method-name="createFinInvoiceLine" short-description="Create FinInvoiceLine">
        <!--<check-permission permission="INVOICE" action="_CREATE">
            <fail-property resource="CommonUiLabels" property="CommonGenericPermissionError"/>
        </check-permission>-->
        <check-errors/>

        <!-- Verifica que exista la cabecera -->
        <entity-and entity-name="FinInvoice" list="hdrList">
            <field-map field-name="invoiceId" from-field="parameters.invoiceId"/>
        </entity-and>
        <if-empty field="hdrList">
            <add-error><fail-message message="FinInvoice ${parameters.invoiceId} not found. Cannot create line."/></add-error>
            <check-errors/>
            <return response-code="error"/>
        </if-empty>

        <make-value entity-name="FinInvoiceLine" value-field="newFinInvoiceLine"/>
        <set-nonpk-fields map="parameters" value-field="newFinInvoiceLine"/>
        <set-pk-fields   map="parameters" value-field="newFinInvoiceLine"/>

        <if-empty field="newFinInvoiceLine.invoiceLineSeqId">
            <sequenced-id sequence-name="FinInvoiceLine" field="newFinInvoiceLine.invoiceLineSeqId"/>
        </if-empty>

        <create-value value-field="newFinInvoiceLine"/>
        <field-to-result field="newFinInvoiceLine.invoiceId"        result-name="invoiceId"/>
        <field-to-result field="newFinInvoiceLine.invoiceLineSeqId" result-name="invoiceLineSeqId"/>
        <log level="info" message="FinInvoiceLine created for invoice ${invoiceId} with line ID: ${invoiceLineSeqId}"/>
        <return response-code="success"/>
    </simple-method>

    <!-- ========================= -->
    <!-- FinInvoiceLine - UPDATE   -->
    <!-- ========================= -->
    <simple-method method-name="updateFinInvoiceLine" short-description="Update FinInvoiceLine">
        <!--<check-permission permission="INVOICE" action="_UPDATE">
            <fail-property resource="CommonUiLabels" property="CommonGenericPermissionError"/>
        </check-permission>-->
        <check-errors/>

        <entity-and entity-name="FinInvoiceLine" list="finInvoiceLines">
            <field-map field-name="invoiceId"        from-field="parameters.invoiceId"/>
            <field-map field-name="invoiceLineSeqId" from-field="parameters.invoiceLineSeqId"/>
        </entity-and>
        <if-empty field="finInvoiceLines">
            <add-error><fail-message message="FinInvoiceLine for Invoice ID ${parameters.invoiceId} and Line ID ${parameters.invoiceLineSeqId} not found."/></add-error>
            <check-errors/>
            <return response-code="error"/>
        </if-empty>

        <first-from-list list="finInvoiceLines" entry="finInvoiceLineToUpdate"/>
        <set-nonpk-fields map="parameters" value-field="finInvoiceLineToUpdate"/>
        <store-value value-field="finInvoiceLineToUpdate"/>

        <log level="info" message="FinInvoiceLine for invoice ${parameters.invoiceId} with line ID: ${parameters.invoiceLineSeqId} updated."/>
        <!-- Fijar un OUT 'invoiceId' robusto -->
        <set field="invoiceIdOut" from-field="parameters.invoiceId"/>
        <if-empty field="invoiceIdOut">
            <set field="invoiceIdOut" from-field="finInvoiceLineToUpdate.invoiceId"/>
        </if-empty>
        <field-to-result field="invoiceIdOut" result-name="invoiceId"/>
        <return response-code="success"/>
    </simple-method>

    <!-- ========================= -->
    <!-- FinInvoiceLine - DELETE   -->
    <!-- ========================= -->
    <simple-method method-name="deleteFinInvoiceLine" short-description="Delete FinInvoiceLine">
        <!--<check-permission permission="INVOICE" action="_DELETE">
            <fail-property resource="CommonUiLabels" property="CommonGenericPermissionError"/>
        </check-permission>-->
        <check-errors/>

        <entity-and entity-name="FinInvoiceLine" list="finInvoiceLines">
            <field-map field-name="invoiceId"        from-field="parameters.invoiceId"/>
            <field-map field-name="invoiceLineSeqId" from-field="parameters.invoiceLineSeqId"/>
        </entity-and>
        <if-empty field="finInvoiceLines">
            <add-error><fail-message message="FinInvoiceLine for Invoice ID ${parameters.invoiceId} and Line ID ${parameters.invoiceLineSeqId} not found for deletion."/></add-error>
            <check-errors/>
            <return response-code="error"/>
        </if-empty>

        <first-from-list list="finInvoiceLines" entry="finInvoiceLineToDelete"/>
        <remove-value value-field="finInvoiceLineToDelete"/>

        <log level="info" message="FinInvoiceLine for invoice ${parameters.invoiceId} with line ID: ${parameters.invoiceLineSeqId} deleted."/>
        <return response-code="success"/>
    </simple-method>

</simple-methods>
